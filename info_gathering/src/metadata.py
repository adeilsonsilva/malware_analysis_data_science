#!/usr/bin/env python

##################################################
## Universidade Federal da Bahia
##################################################
## GPLv3
##################################################
## Author: Adeilson Silva
## Mmaintainer: github.com/adeilsonsilva
## Email: adeilson@protonmail.com
##################################################

import os
import subprocess

def get_csv(dataset_path, output_path):
    out_file = open(output_path, "w")

    # Get absolute path to avoid mistakes
    abs_path = os.path.abspath(dataset_path)

    print("** Extracting metadata from database at \'{}\'.".format(abs_path))

    # CSV Header
    out_file.write("\"FILE\", \"DATE\", \"TYPE\", \"SIZE\", \"MAIN_EXT\", \"OTHER_EXT\"\n")

    # Walk in directory
    for root, subdir, filenames in sorted(os.walk(abs_path)):
        for name in filenames:
            # Get path to file
            filepath = "{}/{}".format(root, name)

            # Get file extensions
            head, extension = os.path.splitext(filepath)
            other_ext = []
            ext = extension
            while(ext != ''):
                other_ext.append(ext)
                head, ext = os.path.splitext(head)
            all_exts = ', '.join(other_ext)

            # Get disk file size
            filesize = os.path.getsize(filepath)
            filesize /= 1000000 # Bytes to MB

            # Collected at date (in this dataset it is the folder name)
            collected_at = root.split('/')[-1]

            # Run bash command 'file'
            filetype = subprocess.check_output(['file', filepath, '-b'], shell=False).strip().decode("utf-8")

            # Write results to CSV file
            out_file.write("\"{}\", \"{}\", \"{}\", \"{}\", \"{}\", \"{}\"\n".format(filepath, collected_at, filetype, filesize, extension, all_exts))

    print("** FINISHED! Saving results to \'{}\'.".format(output_path))
    out_file.close()
